<!doctype html>

<html>
<head>
	<style>
		#rowContainer{
			display: flex;
			justify-content: center;
			flex-direction: row;
		}
		#topHeader{
			width: 100%;
			height: 100px;
			font-size: 30px;
			display: flex;
			justify-content: center;
			flex-direction: row;
			font-family: 'Roboto', sans-serif;

		}
		#columnContainer{
			flex-direction: column;
			justify-content: center;
			padding: 1%;
			margin-bottom: auto;
		}
		#map {
  			width: 900px;
    		height: 500px;
		}
		#body
		{
			background-color: rgb(238, 238, 238);
		}
		.header {
			 text-align: center;
			 background-color: white;
			 color: rgb(166, 166, 168);
			 font-size: 12px;
			 font-family: 'Roboto', sans-serif;
		}
		#topHeader{
			 text-align: center;
			 height: 5%;
			 color: rgb(183, 186, 191);
			 background-color: white;
			 font-size: 16px;
			 font-family: 'Roboto', sans-serif;
		}
		#Tabulate{
			 background-color: white;
			 color: #2E1114;
			 font-size: 14px;
			 font-family: 'Roboto', sans-serif;
		}
		#graphDiv{
			font-family: 'Roboto', sans-serif;
			background-color: white;
			color: rgb(166, 166, 168);
			justify-content: center;
		}
		#weaponTabulate{
			font-family: 'Roboto', sans-serif;
			background-color: white;
			font-size: 14px;
			color: rgb(166, 166, 168);
		}
	</style>
</head>
<script src="http://www.w3schools.com/lib/w3data.js"></script>
<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
<link href="https://fonts.googleapis.com/css?family=Roboto&display=swap" rel="stylesheet">
<script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
	<div id = "topHeader">
		<h1>TERROR DATA AROUND THE WORLD </h1>
	</div>
	<body id = "body">
		<div id = "rowContainer" >
			<div id="columnContainer">
				<div id = "weaponTabulate">
					<div class="header">
  						<h1>Which terror organization executed the attack? </h1>
  						<p>Click on the group to filter the map view.</p>
					</div>
					<script src="https://d3js.org/d3.v4.js"></script>
		   				<script>
							 //Graph: Killed over years
							 var graphData = {{ data.chart_data | safe}}
							 //Graph: List over most dangerous groups
							 var graphData_group = {{ data_group.chart_data_group | safe}}
							//Graph: Connect map to some window, dont need this here i think since it declared in map
							var graphData_location = {{data_location.chart_data_location | safe}}
							// Graph: list of most used weapons
							var graphData_weapon = {{data_weapon.chart_data_weapon | safe}}


							
							//Graph: Killed over years
							var margin = {top: 10, right: 30, bottom: 30, left: 60};
							var graphWidth = 460 - margin.left - margin.right;
			    			var graphHeight = 400 - margin.top - margin.bottom;

			    			var svg = d3.select("#weaponTabulate")
					    	.append("svg")
						       	.attr("width", graphWidth + margin.left + margin.right)
						       	.attr("height", graphHeight + margin.top + margin.bottom)
					   		.append("g")
					       	.attr("transform",
					       		"translate(" + margin.left + "," + margin.top + ")");

					       	function drawWeaponGraph(data){
					       		
					       		//Adding x-axis
								var x = d3.scaleLinear()
								    .domain(d3.extent(data, function(d) { return d.Killed; }))
								    .range([ 0, graphWidth]);

							 	svg.append("g")
							 		.attr("transform", "translate(0," + graphHeight + ")")
							    	.call(d3.axisBottom(x))
							    	.selectAll("text")
							      		.attr("transform", "translate(-10,0)rotate(-45)")
							      		.style("text-anchor", "end")
							      		.attr("font-family", function(d,i) {return i<5 ? "Roboto" : "sans-serif"; })
						

							    //Adding y-axis
							    var y = d3.scaleBand()
							    	.range([0, graphHeight])
							    	.domain(data.map(function(d) { return d.Weapon_type; }));

							    svg.append("g")
							    	.call(d3.axisLeft(y));

							    //Adding bars
							    svg.selectAll("myRect")
							    	.data(data)
							    	.enter()
							    	.append("rect")
							    	.attr("x", x(0))
							    	.attr("y", function(d) {return y(d.Weapon_type);})
							    	.attr("width", function(d) {return x(d.Killed);})
							    	.attr("height", y.bandwidth()-5)
							    	.attr("fill", "red")
							    	.on("mouseover", function() {
						            d3.select(this)
						            	.attr("fill", "blue");
						        	})
						        	.on("mouseout", function() {
							            d3.select(this)
							            	.attr("fill", "red");
							        });
 

							

					       	}

					       	drawWeaponGraph(graphData_weapon);


	    				</script>
	    		</div>
			</div>
			<div id="columnContainer">
				<div id ="map">
	   				<script type="text/javascript">
					  	// The first parameter are the coordinates of the center of the map

					  	// The second parameter is the zoom level
						var graphData_location = {{data_location.chart_data_location | safe}}
						var map = null;


						function drawMap(data, val){

								data.forEach(function(d) {
								    	d.Killed = d.Killed;
								    	d.Weapon_type = d.Weapon_type;
								});


							if (map !== undefined && map !== null) {
								map.remove(); // should remove the map from UI and clean the inner children of DOM element
							 	//console.log(map); // nothing should actually happen to the value of mymap
							}

							map = L.map('map').setView([41.90, 	12.46], 2);
		   				//	console.log(data);
							var layer = L.tileLayer('http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
						    	attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="http://cartodb.com/attributions">CartoDB</a>'});

							var myMarker = null;

							//Get the radius of the marker based on number of killed persons at attack.
							function getRadius(r) {
								return  r > 1000 ? 12 :
								        r > 400 ? 9 :
								        r > 200 ? 6 :
								        r > 100 ? 4 :
								        2;
								}

								function getColor(r) {
									return r > 1000 ? "#581845" :
												r > 400 ? "#900C37" :
												r > 200 ? "#C70039" :
												r > 100 ? "#FF5733" :
												"#FFC300";

								}
							//Placing out the markers
							for( var i=0; i < data.length; ++i)
							{
								if(val == 0 || val == data[i].Group){
									if(data[i].Lat && data[i].Long){
										radiusSize = getRadius(data[i].Killed);
										killedColor = getColor(data[i].Killed);

										myMarker = L.circleMarker( [data[i].Lat, data[i].Long], {
										    radius: radiusSize,
										    fillColor: killedColor,
										    color: killedColor,
										    fillOpacity: 0.6
									  	}).addTo(map);

										var list = "<dt>Killed persons in attack: "
												   + data[i].Killed + "</dt>"
										           + "<dt>Group: "
										           + data[i].Group + "</dt>";

									  	myMarker.bindPopup(list);
									}
								}
							}


						  	map.addLayer(layer);

						  	};

							drawMap(graphData_location, 0);
					</script>
				</div>
	   		<div id="graphDiv">
					<p>Killed per year </p>
				<script src="https://d3js.org/d3.v4.js"></script>
	   				<script>
				 		//Graph: Killed over years
				 		var graphData = {{ data.chart_data | safe}}
				 		//Graph: List over most dangerous groups
				 		var graphData_group = {{ data_group.chart_data_group | safe}}
						//Graph: Connect map to some window, dont need this here i think since it declared in map
						var graphData_location = {{data_location.chart_data_location | safe}}
						// Graph: list of most used weapons
						var graphData_weapon = {{data_weapon.chart_data_weapon | safe}}


						console.log(graphData_group);
				 	  //Graph: Killed over years
				 	 	var margin = {top: 10, right: 30, bottom: 30, left: 60};
						var graphWidth = 460 - margin.left - margin.right;
						var graphWidth_map = 800 - margin.left - margin.right;
    					var graphHeight = 400 - margin.top - margin.bottom;

				    	var svg = d3.select("#graphDiv")
					    	.append("svg")
					       	.attr("width", graphWidth_map + margin.left + margin.right)
					       	.attr("height", graphHeight + margin.top + margin.bottom)
					   		.append("g")
					       	.attr("transform",
					       		"translate(" + margin.left + "," + margin.top + ")");

						//Draw our data.
						function drawGraph(data, data_map) {

							data.forEach(function(d) {
								    	d.Killed = d.Killed;
								    	d.Year = d.Year;
								  	});

							//Data on x-axis.
							var x = d3.scaleLinear()
	      					.domain(d3.extent(data, function(d) { return d.Year; }))
	      					.range([ 0, graphWidth_map ]);

							//xAxis
							var xAxis = svg.append("g")
							.attr("transform", "translate(0," + graphHeight + ")")
							.call(d3.axisBottom(x));

							//Data on yAxis
							var y = d3.scaleLinear()
	      					.domain([0, d3.max(data, function(d) { return d.Killed; })])
	      					.range([ graphHeight, 0 ]);

							//yAxis
							var yAxis = svg.append("g")
							.call(d3.axisLeft(y));

							//our Line
							var killLine = d3.line()
								.x(function(d) { return x(d.Year); })
								.y(function(d) { return y(d.Killed); });


							  //Only this area will be drawn if we use the clip tool.
							var clip = svg.append("defs").append("svg:clipPath")
								 .attr("id", "clip")
								 .append("svg:rect")
							  .attr("width", graphWidth_map)
							  .attr("height", graphHeight)
							  .attr("x", 0)
							  .attr("y", 0);

							  //The brush
						 	var brush = d3.brushX()
							  .extent([[0,0], [graphWidth_map, graphHeight]])
							  .on("end", updateChart);

							  // The path were our line and brush will appear.
					  		var path = svg.append("g").attr("clip-path",
						  	"url(#clip)");

							  //Add line
							  path.append("path")
							  	.datum(data)
							    .style("stroke", "#FF5733")
							    .style("fill", "none")
							    .attr("class", "line")
							    .attr("d", killLine(data));

							  //Add brush
							  path.append("g").attr("class", "brush").call(brush);

							  //sets idleTimeout to zero.
							  var idleTimeout
							  function idled() { idleTimeout = null; }

							  //Updates the chart if we use the cut tool.
							  function updateChart(){

							  	
							  	extent = d3.event.selection;
							  	
							  	
							  	if(extent !=null){
							  		minAxis = Math.round(x.invert(extent[0]));	
							  		maxAxis = Math.round(x.invert(extent[1])); 

							  		filteredNodes = data_map.filter(
									function(d) {
										return (d.Year >= minAxis && d.Year <=maxAxis);
									});

									/*for (var i = 0; i < filteredNodes.length; i++) {
										console.log("Hej")
										console.log(filteredNodes[i].Year);
									    drawMap(graphData_location, filteredNodes[i].Year);
									    //Do something
									}*/
									drawMap(filteredNodes, 0);
									
							  	}
						

							  	// If no selection, back to initial coordinate. Otherwise, update X axis domain
							    if(!extent){
							    	if (!idleTimeout) return idleTimeout = setTimeout(idled, 350); // This allows to wait a little bit
							        x.domain([4,8])
							      	}else{
						      		test = x.domain([ x.invert(extent[0]), x.invert(extent[1]) ]);
							      				        	
							        	path.select(".brush").call(brush.move, null); // This remove the grey brush area as soon as the selection has been done
							        	
							      	}

						      // Update axis and line position
						      xAxis.transition().duration(1000).call(d3.axisBottom(x))
						      path
						          .select('.line')
						          .transition()
						          .duration(1000)
						          .attr("d", d3.line()
						            .x(function(d) { return x(d.Year); })
						            .y(function(d) { return y(d.Killed); })
						          );


							};


							// If user double click, reinitialize the chart
						    svg.on("dblclick",resetGraph);

						    function resetGraph(){

						    x.domain(d3.extent(data, function(d) { return d.Year; }))
						    xAxis.transition().call(d3.axisBottom(x))
						      path
						        .select('.line')
						        .transition()
						        .attr("d", d3.line()
						          .x(function(d) { return x(d.Year) })
						          .y(function(d) { return y(d.Killed) })
						      	)

						     drawMap(graphData_location, 0);

						    };
						};
					

						drawGraph(graphData, graphData_location);

						</script>
				</div>
			</div>
				<div id="columnContainer">
					<div id = "Tabulate">
						<div class="header">
  						<h1>Which terror organization executed the attack? </h1>
  						<p>Click on the group to filter the map view.</p>
					</div>
						<script>
							function drawTabulate(data, columns){

									data.forEach(function(d) {
								    	d.Killed = d.Killed;
								    	d.Group = d.Group;
								  	});

									var table = d3.select("#Tabulate").append("table")
									.attr("width", graphWidth)
						        	.attr("height", graphHeight);

									thead = table.append("thead");
									tbody = table.append("tbody");

									//Append header row
									thead.append("tr")
										.selectAll("th")
										.data(columns)
										.enter()
										.append("th");
										//.text(function(column){return column;});

									// create a row for each object in the data
								    var rows = tbody.selectAll("tr")
								        .data(data)
								        .enter()
								        .append("tr");

								    // create a cell in each row for each column
								    var cells = rows.selectAll("td")
								        .data(function(row) {
								            return columns.map(function(column) {
								                return {column: column, value: row[column]};
								            });
								        })
								        .enter()
								        .append("td")
								        .text(function(d) { return d.value; })
								        .on("click", function(d){

											var group = d.value;
											drawMap(graphData_location, d.value);
										});


								    return table;
								};


								drawTabulate(graphData_group, ["Killed", "Group"]);

						</script>

					</div>
				</div>

			</div>
	</body>
</html>
